import pandas as pd
import matplotlib.pyplot as plt
import os

plt.rcParams['font.family'] = ['arial']

# ============================================================================
# Configuration - Modify paths according to your data location
# ============================================================================
RESULTS_DIR = "./results"  # Results directory (relative path)
VIZ_OUTPUT_DIR = "./results/visualizations"  # Visualization output
os.makedirs(VIZ_OUTPUT_DIR, exist_ok=True)

# **1. Load Feature Importance Data**
# Note: These files are generated by 02_feature_selection_ensemble.py
rf_mean_importance_filepath = f"{RESULTS_DIR}/RandomForest_Selected_Features.xlsx"
xgb_mean_importance_filepath = f"{RESULTS_DIR}/XGBoost_Selected_Features.xlsx"

rf_mean_importance = pd.read_excel(rf_mean_importance_filepath, sheet_name='Sheet1', header=0, index_col=0)
xgb_mean_importance = pd.read_excel(xgb_mean_importance_filepath, sheet_name='Sheet1', header=0, index_col=0)


# **2. Define Plotting Function (with adjustable font sizes)**
def plot_top_feature_importance(importances, model_name, save_path=None, rgb_color=(104 / 255, 172 / 255, 213 / 255),
                                top_n=30,
                                title_fontsize=14,
                                xlabel_fontsize=12,
                                ylabel_fontsize=12,
                                xticks_fontsize=10,
                                yticks_fontsize=10,
                                title_weight='bold',
                                xlabel_weight='bold',
                                ylabel_weight='bold'):
    """
    Plot feature importance bar chart

    Parameters:
    - importances: Feature importance DataFrame
    - model_name: Model name
    - save_path: Output file path
    - rgb_color: RGB color tuple
    - top_n: Number of top features to display
    - title_fontsize: Title font size (default 14)
    - xlabel_fontsize: X-axis label font size (default 12)
    - ylabel_fontsize: Y-axis label font size (default 12)
    - xticks_fontsize: X-axis tick font size (default 10)
    - yticks_fontsize: Y-axis tick font size (default 10)
    - title_weight: Title weight ('bold' or 'normal')
    - xlabel_weight: X-axis label weight
    - ylabel_weight: Y-axis label weight
    """
    plt.figure(figsize=(6, 8))

    # **Get top N features**
    sorted_importances = importances.sort_values(by=importances.columns[0], ascending=False).head(top_n)

    # **Plot horizontal bar chart**
    plt.barh(sorted_importances.index[::-1], sorted_importances.iloc[:, 0][::-1], color=rgb_color)

    # **Remove extra whitespace**
    plt.ylim(-0.5, len(sorted_importances) - 0.5)

    # **Set x-axis label and font size**
    plt.xlabel('Importance', fontsize=xlabel_fontsize, weight=xlabel_weight)

    # **Set y-axis label and font size**
    plt.ylabel('Features', fontsize=ylabel_fontsize, weight=ylabel_weight)

    # **Set title and font size**
    plt.title(f'Top {top_n} Feature Importance - {model_name}',
              fontsize=title_fontsize, weight=title_weight)

    # **Set x-axis tick font size**
    plt.xticks(fontsize=xticks_fontsize)

    # **Set y-axis tick font size (feature names) and weight**
    plt.yticks(fontsize=yticks_fontsize, weight='bold')

    plt.tight_layout()

    # **Save or display figure**
    if save_path:
        plt.savefig(save_path, dpi=300, bbox_inches='tight')
        print(f"Figure saved to: {save_path}")
    else:
        plt.show()


# **3. Color Settings**
rgb_color_rf = (138 / 255, 126 / 255, 204 / 255)
rgb_color_xgb = (105 / 255, 148 / 255, 97 / 255)

# **4. Plot Feature Importance (with adjustable font sizes)**
print("Plotting Random Forest feature importance...")
plot_top_feature_importance(
    rf_mean_importance, "Random Forest",
    save_path=f"{VIZ_OUTPUT_DIR}/RF_feature_importance.png",
    rgb_color=rgb_color_rf,
    top_n=20,
    title_fontsize=16,  # Title font size
    xlabel_fontsize=13,  # X-axis label font size
    ylabel_fontsize=13,  # Y-axis label font size
    xticks_fontsize=11,  # X-axis tick font size
    yticks_fontsize=10,  # Y-axis tick font size (feature names)
    title_weight='bold',
    xlabel_weight='bold',
    ylabel_weight='bold'
)

print("Plotting XGBoost feature importance...")
plot_top_feature_importance(
    xgb_mean_importance, "XGBoost",
    save_path=f"{VIZ_OUTPUT_DIR}/XGBoost_feature_importance.png",
    rgb_color=rgb_color_xgb,
    top_n=20,
    title_fontsize=16,  # Title font size
    xlabel_fontsize=13,  # X-axis label font size
    ylabel_fontsize=13,  # Y-axis label font size
    xticks_fontsize=11,  # X-axis tick font size
    yticks_fontsize=10,  # Y-axis tick font size (feature names)
    title_weight='bold',
    xlabel_weight='bold',
    ylabel_weight='bold'
)

print("\n" + "=" * 50)
print("Both charts have been plotted and saved!")
print("=" * 50)